<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project 2</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      font-family: Arial;
    }

    .tooltip {
      /* To fix the oscillation */
      pointer-events: none;
    }

    .x-axis text {
      transform: rotate(-15deg) translate(-10px);
    }

    .flex-container {
      display: flex;
    }

    #filters {
      margin-top: 10px;
      padding-left: 10px;
      padding-right: 10px;
      width: 350px;
      height: 400px;
      border: 1px solid black;
    }

    .domain {
      display: none;
    }

    .bar {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h3>Exploration of Popular Artists and Songs</h3>
  <p>Main Visualization (Top 10 Artists)</p>
  <div class="flex-container">
    <div id="filters">
      <span>
        <p>Filter by Gender:</p>

        <input type="checkbox" class="gendercheckbox" value="female" id="female" />
        <label for="female"> Female</label>

        <input type="checkbox" class="gendercheckbox" value="male" id="male" />
        <label for="male"> Male</label>

        <input type="checkbox" class="gendercheckbox" value="mixed" id="group" />
        <label for="group"> Group</label>
      </span>
      <span>
        <p>Filter by Country:</p>

        <input type="checkbox" class="countrycheckbox" value="US" id="us" />
        <label for="us"> US</label>
        <input type="checkbox" class="countrycheckbox" value="CA" id="can" />
        <label for="can"> Canada</label>
        <input type="checkbox" class="countrycheckbox" value="GB" id="gb" />
        <label for="gb"> Great Britain</label>
        <input type="checkbox" class="countrycheckbox" value="FR" id="fr" />
        <label for="fr"> France</label>
        <input type="checkbox" class="countrycheckbox" value="AU" id="au" />
        <label for="au"> Australia</label>
        <input type="checkbox" class="countrycheckbox" value="CO" id="co" />
        <label for="co"> Colombia</label>
        <input type="checkbox" class="countrycheckbox" value="DE" id="de" />
        <label for="de"> Germany</label>
        <input type="checkbox" class="countrycheckbox" value="IE" id="ie" />
        <label for="ie"> Ireland</label>
        <input type="checkbox" class="countrycheckbox" value="NL" id="nl" />
        <label for="nl"> Netherlands</label>
        <input type="checkbox" class="countrycheckbox" value="SE" id="se" />
        <label for="se"> Sweden</label>
      </span>
    </div>
    <svg id="bars" width="850" height="400" style="margin-top: 10px; margin-bottom: 0px; border: 1px solid black"></svg>
  </div>
  <script>
    const svg = d3.select("#bars");
    const svgfilter = d3.select("#filters");

    let annotations = svg.append("g").attr("id", "annotations");

    const width = svg.attr("width");
    const height = svg.attr("height");
    const margins = { left: 70, right: 50, top: 30, bottom: 70 };

    const chartWidth = width - margins.left - margins.right;
    const chartHeight = height - margins.top - margins.bottom;

    let chart = svg
      .append("g")
      .attr("transform", `translate(${margins.left},${margins.top})`);

    const requestData = async () => {
      let [spotifyData, artistData, artists2] = await Promise.all([
        d3.csv("spotifyfixed.csv"),
        d3.csv("spotify-artist-metadata.csv"),
        d3.csv("artistdatasorted.csv"),
      ]);

      let topTen = getTopTen(spotifyData);
      let topTenMap = new Map(topTen);

      // setup scales (y will remain constant)
      let y = d3.scaleLinear().domain([0, 17]).range([chartHeight, 0]);
      let x = d3
        .scaleBand()
        .domain(topTenMap.keys())
        .range([0, chartWidth])
        .padding(0.05);

      // draw axes
      let leftAxis = d3.axisLeft(y).ticks(7).tickFormat(d3.format(".0f"));
      let leftGridlines = d3
        .axisLeft(y)
        .ticks(10)
        .tickSize(-chartWidth - 10)
        .tickFormat("");
      annotations
        .append("g")
        .attr("class", "y-axis")
        .attr("transform", `translate(${margins.left - 10},${margins.top})`)
        .transition()
        .call(leftAxis);
      annotations
        .append("g")
        .attr("class", "y-gridlines")
        .attr("transform", `translate(${margins.left - 10},${margins.top})`)
        .transition()
        .call(leftGridlines);
      svg
        .append("text")
        .attr("class", "y-label")
        .attr("text-anchor", "end")
        .attr("x", -100)
        .attr("y", 25)
        .attr("transform", "rotate(-90)")
        .text("# of Popular Songs");

      let bottomAxis = d3.axisBottom(x).ticks(x.domain().length);
      annotations
        .append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(${margins.left},330)`)
        .transition()
        .call(bottomAxis);
      svg
        .append("text")
        .attr("class", "x-label")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2 + 30)
        .attr("y", chartHeight + 80)
        .text("Artist");

      // draw bars
      topTenMap.forEach((d, i) => {
        chart
          .append("rect")
          .attr("class", "bar")
          .attr("width", x.bandwidth())
          .attr("height", chartHeight - y(d.length))
          .attr("x", x(d[0].artist))
          .attr("y", y(d.length))
          .attr("fill", "#1DB954")
          .transition();
      });

      // topTenMap.forEach((d, i) => {
      //       chart
      //         .append("line")
      //         .attr("class", "bar")
      //         .attr("x1", x(d[0].artist) + margins.left / 2)
      //         .attr("x2", x(d[0].artist) + margins.left / 2)
      //         .attr("y1", chartHeight)
      //         .attr("y2", y(d.length))
      //         .style("stroke", "#1DB954")
      //         .style("stroke-width", x.bandwidth());
      //     });

      let bars = d3.selectAll(".bar");
      bars.data(topTen);

      // draw tooltip
      let tooltipWidth = 150;
      let tooltipHeight = 40;

      let tooltip = chart
        .append("g")
        .attr("class", "tooltip")
        .attr("visibility", "hidden");
      tooltip
        .append("rect")
        .attr("fill", "black")
        .attr("opacity", 0.5)
        .attr("x", -tooltipWidth / 2.0)
        .attr("y", 0)
        .attr("width", tooltipWidth)
        .attr("height", tooltipHeight);

      let txt = tooltip
        .append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 5);

      let txt2 = tooltip
        .append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 25);

      function mouseEntersPlot() {
        console.log("entered bar");
        // Make tooltip visible
        tooltip.style("visibility", "visible");

        let bar = d3.select(this);
        let curName = bar.datum()[0];
        let numOccurrences = bar.datum()[1].length;

        txt.text(curName);
        txt2.text(numOccurrences);

        // let xPos = x(curName);
        // let yPos = y(occurrences);

        // Transform the <g> group so that everything moves together easily
        tooltip.attr("transform", `translate(${350},${-30})`);

        d3.select(this)
          .transition().duration(200)
          .attr("stroke", "#949494")
          .attr("stroke-width", 4);

      }

      function mouseLeavesPlot() {
        tooltip.style("visibility", "hidden");
        d3.select(this).transition().duration(200)
          .attr("opacity", 1)
          .attr("stroke-width", 0)
      }

      function filter() {
        var genderchoices = [];
        d3.selectAll(".gendercheckbox").each(function (d) {
          cb = d3.select(this);
          if (cb.property("checked")) {
            genderchoices.push(cb.property("value"));
          }
        });

        if (genderchoices.length > 0) {
          newData = spotifyData.filter(function (d, i) {
            artist = artistData.filter(function (a, j) {
              return a.artist === d.artist;
            });
            if (artist[0] === undefined) {
              return false;
            } else {
              return genderchoices.includes(artist[0]["gender"]);
            }
          });
        } else {
          newData = spotifyData;
        }

        var countrychoices = [];
        d3.selectAll(".countrycheckbox").each(function (d) {
          cb = d3.select(this);
          if (cb.property("checked")) {
            countrychoices.push(cb.property("value"));
          }
        });

        if (countrychoices.length > 0) {
          newData = newData.filter(function (d, i) {
            artist = artistData.filter(function (a, j) {
              return a.artist === d.artist;
            });
            if (artist[0] === undefined) {
              return false;
            } else {
              return countrychoices.includes(artist[0]["country"]);
            }
          });
        }

        newData = getTopTen(newData);

        return newData;
      }

      function getTopTen(data) {
        let artistsSorted = new Map(
          [...d3.group(data, (d) => d.artist)].sort((a, b) => {
            if (a[1].length < b[1].length) {
              return -1;
            }
            if (a[1].length > b[1].length) {
              return 1;
            }
            return 0;
          })
        );
        let topTen = Array.from(artistsSorted).reverse().slice(0, 10);

        return topTen;
      }

      function update(newData) {
        // clear old bars
        d3.selectAll("svg .bar").remove();

        let dataMap = new Map(newData);

        // update x-scale
        let x = d3
          .scaleBand()
          .domain(dataMap.keys())
          .range([0, chartWidth])
          .padding(0.05);

        dataMap.forEach((d, i) => {
          chart
            .append("rect")
            .attr("class", "bar")
            .attr("width", x.bandwidth())
            .attr("height", chartHeight - y(d.length))
            .attr("x", x(d[0].artist))
            .attr("y", y(d.length))
            .attr("fill", "#1DB954")
            .transition();
        });

        let bars = d3.selectAll(".bar");
        bars
          .on("mouseenter", mouseEntersPlot)
          .on("mouseout", mouseLeavesPlot);
        bars.data(newData);

        refreshAxis(x);
      }

      function refreshAxis(x) {
        // clear old stuff
        d3.selectAll(".x-axis,.x-label").remove();

        let bottomAxis = d3.axisBottom(x);
        annotations
          .append("g")
          .attr("class", "x-axis")
          .attr("transform", `translate(${margins.left},330)`)
          .transition()
          .call(bottomAxis);
      }

      d3.selectAll(".bar").on("mouseenter", mouseEntersPlot);
      d3.selectAll(".bar").on("mouseout", mouseLeavesPlot);

      d3.selectAll("input").on("change", function () {
        var filteredData = filter();
        update(filteredData);
      });
    };

    requestData();
  </script>
</body>

</html>